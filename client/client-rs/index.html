<html>
<meta charset="UTF-8">
<head>
<title></title>
<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript">

    if (typeof String.prototype.startsWith != 'function') {
      String.prototype.startsWith = function (str){
        return this.slice(0, str.length) == str;
      };
    }
    
    $(document).ready(function(){
        //var canv = $('#canvas');
        var canv = document.getElementById('canvas');
        var ctx = canv.getContext('2d');
        ctx.fillStyle = 'rgba(200,200,200,1)';
        ctx.fillRect(0, 0, canv.width, canv.height);

        $('#get-objects').on('click', function(){
            $.getJSON('http://localhost:33000/objects', function(data) {
                var h = "";
                var minx = data[0].x;
                var miny = data[0].y;
                for (var i=1; i<data.length; ++i) {
                    e = data[i];
                    if (e.x < minx) { minx = e.x; }
                    if (e.y < miny) { miny = e.y; }
                }
                ctx.fillRect(0, 0, canv.width, canv.height);
                for (var i=0; i<data.length; ++i) {
                    e = data[i];
                    var x = e.x - minx;
                    var y = e.y - miny;
                    ctx.strokeStyle = '#000000';
                    ctx.strokeRect(10+x-5, 10+y-5, 10, 10);
                    h += "("+e.x+","+e.y+") "+"("+x+","+y+") "+e.resid+" "+e.resname+"<br>";
                }
                $('#show').html("<p>"+h+"</p>");
            });
        });

        $('#get-widgets').on('click', function(){
            $.getJSON('http://localhost:33000/widgets', function(data) {
                var h = "";
                for (var i=1; i<data.length; ++i) {
                    e = data[i];
                    h += e.id+"     "+e.name+'     '+e.parent+"<br>";
                }
                $('#show').html("<p>"+h+"</p>");
            });
        });

        $('#quit').on('click', function(){
            $.get('http://localhost:33000/quit');
        });

        var redraw = function(){
            $.getJSON('http://localhost:33000/objects', function(data){
                var minx = data[0].x;
                var miny = data[0].y;
                for (var i=1; i<data.length; ++i) {
                    e = data[i];
                    if (e.x < minx) { minx = e.x; }
                    if (e.y < miny) { miny = e.y; }
                }
                ctx.fillStyle = 'rgba(200,200,200,1)';
                ctx.fillRect(0, 0, canv.width, canv.height);
                var borka = "";
                for (var i=0; i<data.length; ++i) {
                    e = data[i];
                    var x = e.x - minx;
                    var y = e.y - miny;
                    if (e.resname.startsWith('gfx/borka')) {
                        borka = "( "+e.x+" , "+e.y+" )";
                        //ctx.strokeStyle = '#000000';
                        //ctx.strokeRect(10+x-5, 10+y-5, 10, 10);
                        ctx.fillStyle = 'rgba(0,0,255,0.5)';
                    } else if (e.resname.startsWith('gfx/kritter')) {
                        ctx.fillStyle = 'rgba(255,0,0,0.5)';
                    } else if (e.resname.startsWith('gfx/terobjs')) {
                        ctx.fillStyle = 'rgba(0,255,0,0.5)';
                    } else {
                        ctx.fillStyle = 'rgba(0,255,255,0.5)';
                    }
                    ctx.fillRect(10+x-5, 10+y-5, 10, 10);
                }
                $('#borka').html(borka);
                setTimeout(redraw, 300);
            });
        }

        redraw();
    });
    $(document).ajaxError(function(e, xhr, settings, exception){
        console.log('ERROR: ' + settings.url + ', ' + exception);
    });
</script>
</head>
<body>
<a href="#" id="get-objects">Objects</a>
<a href="#" id="get-widgets">Widgets</a>
<a href="#" id="quit">Quit</a>
<div id="borka"></div>
<div><canvas height='920' width='920' id='canvas'>Canvas</canvas></div>
<div id="show"></div>
</body>
</html>
